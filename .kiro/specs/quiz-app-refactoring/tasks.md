# Implementation Plan: Quiz App Refactoring (Phase 1)

## Overview

Phase 1 refactoring tập trung vào cải thiện authentication flow, token management, pagination, frontend architecture, API documentation, và search functionality. Implementation sẽ được thực hiện theo từng phase nhỏ với testing sau mỗi phase để đảm bảo tính ổn định.

## Tasks

- [x] 1. Setup and Dependencies
  - Add required dependencies to backend (SpringDoc OpenAPI, jqwik for property testing)
  - Add required dependencies to frontend (axios, fast-check for property testing)
  - Configure Swagger/OpenAPI in Spring Boot
  - _Requirements: 11.1_

- [x] 2. Backend: Create DTOs for Authentication
  - [x] 2.1 Create AuthResponse DTO with accessToken, refreshToken, and user fields
    - _Requirements: 2.1_
  - [x] 2.2 Create TokenResponse DTO with accessToken and refreshToken fields
    - _Requirements: 2.5_
  - [x] 2.3 Create SignupRequest DTO with validation annotations
    - Add @NotBlank, @Email, @Size annotations
    - _Requirements: 2.1_
  - [x] 2.4 Create LoginRequest DTO with validation annotations
    - _Requirements: 2.1_
  - [x] 2.5 Create RefreshRequest and LogoutRequest DTOs
    - _Requirements: 2.5, 2.6_

- [x] 3. Backend: Implement RefreshTokenService
  - [x] 3.1 Create RefreshTokenService interface with CRUD methods
    - createRefreshToken(User user)
    - verifyRefreshToken(String token)
    - deleteByToken(String token)
    - deleteByUser(User user)
    - _Requirements: 2.1, 2.5, 2.6_
  - [x] 3.2 Implement RefreshTokenServiceImpl
    - Generate UUID for token value
    - Set expiry to 7 days from creation
    - Save to database with user relationship
    - _Requirements: 2.3, 2.5_
  - [ ]\* 3.3 Write property test for refresh token expiry
    - **Property 3: Refresh token expiry is 7 days**
    - **Validates: Requirements 2.3**
  - [ ]\* 3.4 Write unit tests for RefreshTokenService
    - Test token creation
    - Test token verification
    - Test token deletion
    - _Requirements: 2.5, 2.6_

- [x] 4. Backend: Update JwtUtil for configurable expiry
  - [x] 4.1 Update generateAccessToken to use 15-minute expiry from config
    - Read from application.properties: jwt.access.expiration=900000 (15 min in ms)
    - _Requirements: 2.2_
  - [x] 4.2 Update generateRefreshToken method (if exists, or remove if using RefreshTokenService)
    - _Requirements: 2.3_
  - [ ]\* 4.3 Write property test for JWT token expiry
    - **Property 2: JWT token expiry is 15 minutes**
    - **Validates: Requirements 2.2**

- [x] 5. Backend: Create AuthService
  - [x] 5.1 Create AuthService interface
    - signup(SignupRequest request): AuthResponse
    - login(LoginRequest request): AuthResponse
    - refreshToken(String refreshToken): TokenResponse
    - logout(String refreshToken): void
    - _Requirements: 1.2, 2.1_
  - [x] 5.2 Implement AuthServiceImpl.signup
    - Validate email not already exists
    - Hash password with BCrypt
    - Set role to USER
    - Save user
    - Generate JWT and refresh token
    - Return AuthResponse
    - _Requirements: 2.1_
  - [x] 5.3 Implement AuthServiceImpl.login
    - Authenticate with AuthenticationManager
    - Generate JWT and refresh token
    - Save refresh token to database
    - Return AuthResponse with both tokens
    - _Requirements: 2.1_
  - [x] 5.4 Implement AuthServiceImpl.refreshToken
    - Verify refresh token from database
    - Check expiry
    - Generate new JWT and new refresh token
    - Delete old refresh token
    - Save new refresh token
    - Return TokenResponse
    - _Requirements: 2.5_
  - [x] 5.5 Implement AuthServiceImpl.logout
    - Find and delete refresh token from database
    - _Requirements: 2.6_
  - [ ]\* 5.6 Write property test for login generates both tokens
    - **Property 1: Login generates both tokens**
    - **Validates: Requirements 2.1**
  - [ ]\* 5.7 Write property test for refresh token generates new tokens
    - **Property 4: Refresh token generates new tokens**
    - **Validates: Requirements 2.5**
  - [ ]\* 5.8 Write property test for logout invalidates refresh token
    - **Property 5: Logout invalidates refresh token**
    - **Validates: Requirements 2.6**

- [x] 6. Backend: Create AuthController
  - [x] 6.1 Create AuthController with @RestController and @RequestMapping("/api/auth")
    - Inject AuthService
    - _Requirements: 1.2_
  - [x] 6.2 Implement POST /api/auth/signup endpoint
    - Accept @Valid SignupRequest
    - Call authService.signup()
    - Return AuthResponse
    - Add Swagger annotations
    - _Requirements: 1.2, 11.3_
  - [x] 6.3 Implement POST /api/auth/login endpoint
    - Accept @Valid LoginRequest
    - Call authService.login()
    - Return AuthResponse
    - Add Swagger annotations
    - _Requirements: 1.2, 11.3_
  - [x] 6.4 Implement POST /api/auth/refresh endpoint
    - Accept RefreshRequest
    - Call authService.refreshToken()
    - Return TokenResponse
    - Add Swagger annotations
    - _Requirements: 1.2, 2.5, 11.3_
  - [x] 6.5 Implement POST /api/auth/logout endpoint
    - Accept LogoutRequest
    - Call authService.logout()
    - Return 200 OK
    - Add Swagger annotations
    - _Requirements: 1.2, 2.6, 11.3_
  - [ ]\* 6.6 Write integration tests for AuthController endpoints
    - Test signup flow
    - Test login flow
    - Test refresh flow
    - Test logout flow
    - _Requirements: 1.2_

- [x] 7. Backend: Update UserController
  - [x] 7.1 Remove login and signup endpoints from UserController
    - Keep only profile management endpoints
    - _Requirements: 1.1, 1.3_
  - [x] 7.2 Change @RequestMapping to "/api/users"
    - _Requirements: 1.3_
  - [x] 7.3 Implement GET /api/users/profile endpoint
    - Get current authenticated user from SecurityContext
    - Return UserDTO
    - Add @PreAuthorize("isAuthenticated()")
    - Add Swagger annotations
    - _Requirements: 1.3, 11.3_
  - [x] 7.4 Implement PUT /api/users/profile endpoint
    - Update user name and email
    - Add Swagger annotations
    - _Requirements: 1.3, 11.3_
  - [x] 7.5 Remove unused imports and dependencies
    - _Requirements: 1.5_

- [x] 8. Checkpoint - Backend Auth Restructure Complete
  - Ensure all tests pass
  - Verify Swagger documentation is accessible at /swagger-ui.html
  - Test all auth endpoints manually or with Postman
  - Ask the user if questions arise

- [x] 9. Backend: Add Category to Test Entity
  - [x] 9.1 Add category field to Test entity
    - Add @Column(nullable = false) String category
    - Update getDto() method to include category
    - _Requirements: 13.1_
  - [x] 9.2 Create database migration script
    - ALTER TABLE test ADD COLUMN category VARCHAR(255) NOT NULL DEFAULT 'General'
    - _Requirements: 13.1_
  - [x] 9.3 Update TestDTO to include category field
    - _Requirements: 13.1_

- [x] 10. Backend: Implement Pagination and Search in TestService
  - [x] 10.1 Create PageResponse generic DTO
    - Fields: content, currentPage, pageSize, totalElements, totalPages, last
    - _Requirements: 8.4_
  - [x] 10.2 Update TestRepository with pagination and search methods
    - Add method: Page<Test> findAll(Pageable pageable)
    - Add method: Page<Test> findByCategory(String category, Pageable pageable)
    - Add method: Page<Test> findByTitleContainingIgnoreCase(String search, Pageable pageable)
    - Add method: Page<Test> findByCategoryAndTitleContainingIgnoreCase(String category, String search, Pageable pageable)
    - _Requirements: 8.1, 13.2, 13.3_
  - [x] 10.3 Update TestService interface
    - Change getAllTests() to getTests(int page, int size, String category, String search): PageResponse<TestDTO>
    - _Requirements: 8.1, 13.2, 13.3_
  - [x] 10.4 Implement TestServiceImpl.getTests with pagination and filters
    - Validate page and size are non-negative
    - Default to page=0, size=10 if not provided
    - Apply category filter if provided
    - Apply search filter if provided
    - Convert Page<Test> to PageResponse<TestDTO>
    - _Requirements: 8.3, 8.4, 8.5, 13.4, 13.5, 13.6_
  - [ ]\* 10.5 Write property test for pagination accepts valid parameters
    - **Property 6: Pagination accepts valid parameters**
    - **Validates: Requirements 8.3**
  - [ ]\* 10.6 Write property test for pagination response contains metadata
    - **Property 7: Pagination response contains required metadata**
    - **Validates: Requirements 8.4**
  - [ ]\* 10.7 Write property test for pagination rejects negative parameters
    - **Property 8: Pagination rejects negative parameters**
    - **Validates: Requirements 8.6**
  - [ ]\* 10.8 Write property test for category filter
    - **Property 16: Category filter returns matching tests**
    - **Validates: Requirements 13.4**
  - [ ]\* 10.9 Write property test for search query
    - **Property 17: Search query returns matching tests**
    - **Validates: Requirements 13.5**
  - [ ]\* 10.10 Write property test for combined filters
    - **Property 18: Combined filters return tests matching both criteria**
    - **Validates: Requirements 13.6**

- [x] 11. Backend: Update TestController for Pagination and Search
  - [x] 11.1 Update GET /api/test endpoint
    - Add @RequestParam(defaultValue = "0") int page
    - Add @RequestParam(defaultValue = "10") int size
    - Add @RequestParam(required = false) String category
    - Add @RequestParam(required = false) String search
    - Call testService.getTests(page, size, category, search)
    - Return PageResponse<TestDTO>
    - Update Swagger annotations
    - _Requirements: 8.1, 13.2, 13.3, 11.3_
  - [x] 11.2 Remove unused imports and dependencies from TestController
    - _Requirements: 1.5_
  - [ ]\* 11.3 Write integration tests for pagination and search
    - Test pagination with different page sizes
    - Test category filter
    - Test search query
    - Test combined filters
    - _Requirements: 8.1, 13.2, 13.3_

- [x] 12. Backend: Update Swagger Documentation
  - [x] 12.1 Add @Tag annotations to all controllers
    - AuthController: "Authentication"
    - UserController: "User Profile"
    - TestController: "Tests"
    - _Requirements: 11.6_
  - [x] 12.2 Add @Operation and @ApiResponses to all endpoints
    - Include descriptions, parameters, and response schemas
    - _Requirements: 11.3_
  - [x] 12.3 Add security requirements to protected endpoints
    - Use @SecurityRequirement(name = "bearerAuth")
    - _Requirements: 11.4_
  - [ ]\* 12.4 Write property test for protected endpoints documentation
    - **Property 15: Protected endpoints documented with auth requirements**
    - **Validates: Requirements 11.4**

- [x] 13. Checkpoint - Backend Complete
  - Ensure all tests pass
  - Verify Swagger documentation is complete
  - Test pagination and search manually
  - Ask the user if questions arise

- [x] 14. Frontend: Install Dependencies
  - [x] 14.1 Install axios
    - npm install axios
    - _Requirements: 10.5_
  - [x] 14.2 Install fast-check for property testing
    - npm install --save-dev fast-check
    - _Requirements: 9.2_

- [x] 15. Frontend: Create Axios Instance with Interceptors
  - [x] 15.1 Create src/lib/axiosInstance.ts
    - Create axios instance with baseURL
    - _Requirements: 9.1_
  - [x] 15.2 Add request interceptor to include JWT token
    - Get token from AuthContext
    - Add Authorization header: Bearer <token>
    - _Requirements: 10.1_
  - [x] 15.3 Add response interceptor for error handling
    - Handle 401: trigger token refresh
    - Handle 403: show permission error
    - Handle 404: show not found error
    - Handle 500: show server error
    - _Requirements: 9.2_
  - [x] 15.4 Implement automatic token refresh logic in interceptor
    - On 401 response, call /api/auth/refresh
    - Update token in AuthContext
    - Retry original request with new token
    - If refresh fails, logout and redirect to login
    - _Requirements: 10.2, 10.3, 10.4_
  - [ ]\* 15.5 Write property test for authenticated requests include JWT header
    - **Property 11: Authenticated requests include JWT header**
    - **Validates: Requirements 10.1**
  - [ ]\* 15.6 Write property test for API client handles HTTP errors
    - **Property 9: API client handles HTTP errors consistently**
    - **Validates: Requirements 9.2**
  - [ ]\* 15.7 Write property test for automatic token refresh and retry
    - **Property 12: Automatic token refresh and retry flow**
    - **Validates: Requirements 10.2, 10.3**
  - [ ]\* 15.8 Write property test for failed refresh triggers logout
    - **Property 13: Failed refresh triggers logout**
    - **Validates: Requirements 10.4**

- [x] 16. Frontend: Update AuthContext
  - [x] 16.1 Add accessToken state variable (stored in memory)
    - const [accessToken, setAccessToken] = useState<string | null>(null)
    - _Requirements: 9.5, 10.6_
  - [x] 16.2 Update login function to store both user and accessToken
    - Store user in state
    - Store accessToken in state (memory)
    - Store refreshToken in httpOnly cookie (handled by backend Set-Cookie header)
    - _Requirements: 9.6, 10.1_
  - [x] 16.3 Add updateToken function for axios interceptor
    - setAccessToken(newToken)
    - _Requirements: 10.2_
  - [x] 16.4 Update logout function to clear tokens
    - Call /api/auth/logout endpoint
    - Clear accessToken state
    - Clear user state
    - Refresh token will be cleared by backend (delete cookie)
    - _Requirements: 2.6_
  - [x] 16.5 Remove localStorage usage for user data
    - Keep only in-memory state
    - _Requirements: 10.6_
  - [x] 16.6 Implement session restoration on app load
    - On mount, if no accessToken but refreshToken cookie exists
    - Call /api/auth/refresh to get new accessToken
    - Restore user session
    - _Requirements: 10.7_
  - [ ]\* 16.7 Write property test for session persistence
    - **Property 14: Session persistence with valid refresh token**
    - **Validates: Requirements 10.7**
  - [ ]\* 16.8 Write unit tests for AuthContext
    - Test login function
    - Test logout function
    - Test updateToken function
    - _Requirements: 9.5_

- [x] 17. Frontend: Update API Client Functions
  - [x] 17.1 Update src/lib/api/auth.ts to use axios instance
    - Replace apiFetch with axiosInstance
    - Update loginUser to return AuthResponse
    - Update registerUser to return AuthResponse
    - Add refreshToken function
    - Add logoutUser function
    - _Requirements: 2.1, 2.5, 2.6_
  - [x] 17.2 Update src/lib/api/quiz.ts to use axios instance
    - Replace apiFetch with axiosInstance
    - Update getTests to accept pagination and filter params
    - Update return types to match PageResponse
    - _Requirements: 8.1, 13.2, 13.3_
  - [x] 17.3 Remove old apiFetch from src/lib/apiClient.js
    - _Requirements: 9.1_

- [x] 18. Frontend: Create ProtectedRoute Component
  - [x] 18.1 Create src/components/ProtectedRoute.tsx
    - Check isLoggedIn from AuthContext
    - If not logged in, redirect to /login using Navigate
    - If logged in, render children
    - _Requirements: 9.7_
  - [ ]\* 18.2 Write property test for unauthenticated access redirects
    - **Property 10: Unauthenticated access redirects to login**
    - **Validates: Requirements 9.8**
  - [ ]\* 18.3 Write unit tests for ProtectedRoute
    - Test redirect when not authenticated
    - Test render children when authenticated
    - _Requirements: 9.7, 9.8_

- [x] 19. Frontend: Create ErrorBoundary Component
  - [x] 19.1 Create src/components/ErrorBoundary.tsx
    - Implement componentDidCatch
    - Log errors to console
    - Display fallback UI with error message and reload button
    - _Requirements: 9.3_
  - [ ]\* 19.2 Write unit tests for ErrorBoundary
    - Test error catching
    - Test fallback UI rendering
    - _Requirements: 9.3_

- [x] 20. Frontend: Update App.jsx with ErrorBoundary and ProtectedRoute
  - [x] 20.1 Wrap App with ErrorBoundary
    - _Requirements: 9.3_
  - [x] 20.2 Wrap protected routes with ProtectedRoute component
    - TestListPage, TestTakingPage, TestResultsPage
    - _Requirements: 9.7, 9.8_
  - [x] 20.3 Update routes to use new auth endpoints
    - Login and Register pages should call new /api/auth endpoints
    - _Requirements: 1.2_

- [x] 21. Frontend: Update Pages for Pagination
  - [x] 21.1 Update TestListPage to use pagination
    - Add page state
    - Add pagination controls (Previous, Next, Page numbers)
    - Call getTests with page and size params
    - Display totalPages and currentPage
    - _Requirements: 8.1_
  - [x] 21.2 Add category filter dropdown to TestListPage
    - Add category state
    - Add dropdown with categories
    - Call getTests with category param
    - _Requirements: 13.2_
  - [x] 21.3 Add search input to TestListPage
    - Add search state
    - Add search input field
    - Call getTests with search param
    - Debounce search input
    - _Requirements: 13.3_
  - [ ]\* 21.4 Write integration tests for TestListPage
    - Test pagination controls
    - Test category filter
    - Test search input
    - _Requirements: 8.1, 13.2, 13.3_

- [x] 22. Frontend: Update Loading States
  - [x] 22.1 Update useApi hook to return loading state
    - Already exists, ensure it's used consistently
    - _Requirements: 9.4_
  - [x] 22.2 Add loading spinners to all pages
    - TestListPage, TestTakingPage, TestResultsPage
    - Show spinner when loading is true
    - _Requirements: 9.4_

- [x] 23. Final Checkpoint - Integration Testing
  - [x] 23.1 Test complete auth flow
    - Signup → Login → Access protected page → Logout
    - _Requirements: 1.2, 2.1, 2.6_
  - [x] 23.2 Test token refresh flow
    - Login → Wait for token expiry (or mock) → Make API call → Verify refresh happens
    - _Requirements: 10.2, 10.3_
  - [x] 23.3 Test pagination and search
    - Navigate to test list → Use pagination → Filter by category → Search by title
    - _Requirements: 8.1, 13.2, 13.3_
  - [x] 23.4 Test error handling
    - Trigger 401, 403, 404, 500 errors → Verify error messages
    - _Requirements: 9.2_
  - [x] 23.5 Test session persistence
    - Login → Close browser → Reopen → Verify session restored
    - _Requirements: 10.7_
  - [x] 23.6 Ensure all tests pass
    - Run backend tests: ./mvnw test
    - Run frontend tests: npm test
    - Verify all property tests pass with 100 iterations

- [x] 24. Documentation and Cleanup
  - [x] 24.1 Update README with new API endpoints
    - Document auth endpoints
    - Document pagination parameters
    - Document search and filter parameters
    - _Requirements: 11.3_
  - [x] 24.2 Update README with setup instructions
    - Environment variables for JWT secret
    - Database migration steps
    - Frontend environment variables
  - [x] 24.3 Clean up unused code
    - Remove old apiFetch
    - Remove unused imports
    - _Requirements: 1.5_

## Notes

- Tasks marked with `*` are optional property-based and unit tests that can be skipped for faster MVP
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation at key milestones
- Property tests validate universal correctness properties with minimum 100 iterations
- Unit tests validate specific examples and edge cases
- Backend uses jqwik for property-based testing
- Frontend uses fast-check for property-based testing
